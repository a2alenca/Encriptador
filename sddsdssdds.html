<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario Lotus Flower</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }
    select {
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
    }
    h3 {
      margin-top: 40px;
      background: #ddd;
      padding: 10px;
      border-radius: 5px;
    }
    .tabla-responsive {
      overflow-x: auto;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      th, td {
        padding: 5px;
        font-size: 14px;
      }
      button {
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>

  <h2>Inventario Lotus Flower</h2>

  <label><strong>Responsable del Inventario:</strong></label><br>
  <input type="text" id="responsable" placeholder="Nombre responsable" required><br><br>

  <form id="formularioInventario">
    <div id="contenedorZonas"></div>

    <button type="button" onclick="enviarWhatsApp()">Enviar WhatsApp</button>
    <button type="button" onclick="generarExcel()">Descargar Excel</button>
  </form>

  <script>
    const productos = [
      { nombre: "Coca-Cola", zona: "Bebidas" },
      { nombre: "Pepsi", zona: "Bebidas" },
      { nombre: "Fanta", zona: "Bebidas" },
      { nombre: "Pulpa de mango", zona: "Congelados" },
      { nombre: "Pulpa de piña", zona: "Congelados" },
      { nombre: "Jugo de naranja", zona: "Bebidas" },
      { nombre: "Leche condensada", zona: "Lácteos" },
      { nombre: "Yogurt natural", zona: "Lácteos" },
      { nombre: "Mantequilla", zona: "Lácteos" }
    ];

    const tamanosCaja = [4, 6, 10, 24];

    function agruparPorZona(lista) {
      const zonas = {};
      lista.forEach(p => {
        if (!zonas[p.zona]) zonas[p.zona] = [];
        zonas[p.zona].push(p);
      });
      return zonas;
    }

    function crearTablasPorZona() {
      const contenedor = document.getElementById("contenedorZonas");
      const zonasAgrupadas = agruparPorZona(productos);
      contenedor.innerHTML = '';

      for (const zona in zonasAgrupadas) {
        const productosZona = zonasAgrupadas[zona];

        const encabezado = document.createElement('h3');
        encabezado.textContent = zona;
        contenedor.appendChild(encabezado);

        const tablaWrapper = document.createElement('div');
        tablaWrapper.className = "tabla-responsive";

        const tabla = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>Producto</th>
            <th>Unidades</th>
            <th>Cajas</th>
            <th>Tamaño Caja</th>
            <th>Total</th>
          </tr>
        `;
        tabla.appendChild(thead);

        const tbody = document.createElement('tbody');

        productosZona.forEach(producto => {
          const fila = document.createElement('tr');

          fila.innerHTML = `
            <td>${producto.nombre}</td>
            <td><input type="number" id="${producto.nombre}-unidades" min="0" oninput="actualizarTotal('${producto.nombre}')"></td>
            <td><input type="number" id="${producto.nombre}-cajas" min="0" oninput="actualizarTotal('${producto.nombre}')"></td>
            <td>
              <select id="${producto.nombre}-tamCaja" onchange="actualizarTotal('${producto.nombre}')">
                ${tamanosCaja.map(t => <option value="${t}">Caja de ${t}</option>).join('')}
              </select>
            </td>
            <td><input type="number" id="${producto.nombre}-total" readonly></td>
          `;

          tbody.appendChild(fila);
        });

        tabla.appendChild(tbody);
        tablaWrapper.appendChild(tabla);
        contenedor.appendChild(tablaWrapper);
      }
    }

    function actualizarTotal(nombre) {
      const unidades = parseInt(document.getElementById(${nombre}-unidades).value) || 0;
      const cajas = parseInt(document.getElementById(${nombre}-cajas).value) || 0;
      const tamCaja = parseInt(document.getElementById(${nombre}-tamCaja).value) || 0;
      const total = unidades + cajas * tamCaja;
      document.getElementById(${nombre}-total).value = total;
    }

    function obtenerFechaActual() {
      const f = new Date();
      return ${f.getFullYear()}-${(f.getMonth() + 1).toString().padStart(2, '0')}-${f.getDate().toString().padStart(2, '0')};
    }

    function obtenerDatos() {
      const datos = [];
      productos.forEach(p => {
        const unidades = parseInt(document.getElementById(${p.nombre}-unidades).value) || 0;
        const cajas = parseInt(document.getElementById(${p.nombre}-cajas).value) || 0;
        const tamCaja = parseInt(document.getElementById(${p.nombre}-tamCaja).value) || 0;
        const total = unidades + cajas * tamCaja;

        if (unidades > 0 || cajas > 0) {
          datos.push({
            Zona: p.zona,
            Producto: p.nombre,
            "Unidades sueltas": unidades,
            "Cajas": cajas,
            "Tamaño caja": tamCaja,
            "Total unidades": total
          });
        }
      });
      return datos;
    }

    function enviarWhatsApp() {
      const responsable = document.getElementById("responsable").value || "No indicado";
      const fecha = obtenerFechaActual();
      const datos = obtenerDatos();

      let mensaje = Inventario Lotus Flower\nFecha: ${fecha}\nResponsable: ${responsable}\n\n;

      datos.forEach(d => {
        mensaje += `• [${d.Zona}] ${d.Producto}: `;
        if (d["Unidades sueltas"] > 0) mensaje += ${d["Unidades sueltas"]} unidades;
        if (d["Cajas"] > 0) {
          mensaje += (d["Unidades sueltas"] > 0 ? " + " : "");
          mensaje += ${d["Cajas"]} cajas de ${d["Tamaño caja"]};
        }
        mensaje += ` = ${d["Total unidades"]} total\n`;
      });

      const numero = "56920449772";
      const url = https://wa.me/${numero}?text=${encodeURIComponent(mensaje)};
      window.open(url, "_blank");
    }

    function generarExcel() {
      const responsable = document.getElementById("responsable").value || "No indicado";
      const fecha = obtenerFechaActual();
      const datos = obtenerDatos();

      const cabecera = [
        ["Inventario Lotus Flower"],
        [Fecha: ${fecha}],
        [Responsable: ${responsable}],
        [],
        ["Zona", "Producto", "Unidades sueltas", "Cajas", "Tamaño caja", "Total unidades"]
      ];

      const datosExcel = cabecera.concat(datos.map(d => [
        d.Zona,
        d.Producto,
        d["Unidades sueltas"],
        d["Cajas"],
        d["Tamaño caja"],
        d["Total unidades"]
      ]));

      const hoja = XLSX.utils.aoa_to_sheet(datosExcel);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Inventario");

      const nombreArchivo = inventario_LotusFlower_${fecha}_${responsable.replace(/\s+/g, "_")}.xlsx;
      XLSX.writeFile(libro, nombreArchivo);
    }

    window.onload = crearTablasPorZona;
  </script>

</body>
</html>
